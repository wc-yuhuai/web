<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamBook - 个性化图书管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .app-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .book-info-section, .chapter-section, .content-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .book-info-section, .chapter-section {
            flex: 1;
            min-width: 300px;
        }
        
        .content-section {
            flex: 2;
            min-width: 600px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .section-title i {
            margin-right: 10px;
            color: #3498db;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            font-size: 16px;
            min-width: 120px;
            justify-content: center;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #2ecc71;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #d35400;
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .insert-image-btn {
            background: #9b59b6 !important;
        }
        
        .insert-image-btn:hover {
            background: #8e44ad !important;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .book-cover {
            width: 100%;
            max-width: 200px;
            height: 280px;
            object-fit: cover;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin: 0 auto 15px;
            display: block;
        }
        
        .chapters-container {
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 15px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        
        .chapter-list {
            list-style: none;
        }
        
        .chapter-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .chapter-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .chapter-item.active {
            border-left: 4px solid #2ecc71;
            background: #f0fff4;
        }
        
        .item-content {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .item-number {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin-right: 10px;
            font-size: 12px;
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
        }
        
        .item-actions button {
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .item-actions button:hover {
            color: #3498db;
        }
        
        .content-container {
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 5px;
            background: white;
            min-height: 500px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .content-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .content-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .content-subtitle {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .empty-message {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 30px;
        }
        
        .dragging {
            opacity: 0.5;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .save-indicator {
            color: #27ae60;
            font-weight: bold;
        }
        
        .save-indicator.saving {
            color: #f39c12;
        }
        
        .save-indicator.error {
            color: #e74c3c;
        }
        
        @media (max-width: 1200px) {
            .content-section {
                min-width: 100%;
            }
            
            .app-container {
                flex-direction: column;
            }
        }
        
        @media (max-width: 768px) {
            .book-info-section, .chapter-section {
                min-width: 100%;
            }
        }
        
        .book-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .book-card.active {
            border: 2px solid #3498db;
        }
        
        .book-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .book-card-cover {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 15px;
        }
        
        .book-card-info {
            flex: 1;
        }
        
        .book-card-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .book-card-author {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .book-card-stats {
            display: flex;
            justify-content: space-between;
            color: #95a5a6;
            font-size: 0.8rem;
            margin-top: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .image-frame {
            display: inline-block;
            position: relative;
            margin: 10px;
            border: 2px dashed #3498db;
            border-radius: 5px;
            padding: 5px;
            background: #f8f9fa;
        }
        
        .image-frame img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        .frame-controls {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .image-insert-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .image-insert-form.active {
            display: block;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            overflow: hidden;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        
        .file-input-button {
            display: inline-block;
            padding: 10px 15px;
            background: #3498db;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input-button:hover {
            background: #2980b9;
        }
        
        .unsaved-warning {
            color: #e74c3c;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-book"></i> DreamLib</h1>
            <p class="subtitle">创建、编辑和管理您的个性化图书。自定义书名、封面、章节和内容，并保存至云端数据库。</p>
        </header>
        
        <div class="app-container">
            <!-- 左侧：图书信息 -->
            <section class="book-info-section">
                <h2 class="section-title"><i class="fas fa-book-open"></i> 图书信息</h2>
                
                <div class="controls">
                    <button class="btn" id="newBookBtn">
                        <i class="fas fa-plus"></i> 新建图书
                    </button>
                    <button class="btn btn-success" id="saveBookBtn">
                        <i class="fas fa-save"></i> 保存图书
                    </button>
                    <button class="btn btn-warning" id="loadBookBtn">
                        <i class="fas fa-folder-open"></i> 我的书库
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="bookTitle">书名</label>
                    <input type="text" id="bookTitle" placeholder="请输入图书标题">
                </div>
                
                <div class="form-group">
                    <label for="bookAuthor">作者</label>
                    <input type="text" id="bookAuthor" placeholder="请输入作者姓名">
                </div>
                
                <div class="form-group">
                    <label for="bookDescription">简介</label>
                    <textarea id="bookDescription" placeholder="请输入图书简介"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="bookCover">封面图片</label>
                    <input type="text" id="bookCover" placeholder="粘贴图片链接或上传图片">
                </div>
                
                <div class="controls">
                    <div class="file-input-wrapper">
                        <div class="file-input-button">
                            <i class="fas fa-upload"></i> 上传封面
                        </div>
                        <input type="file" id="coverFileInput" accept="image/*">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>当前封面</label>
                    <img id="coverPreview" class="book-cover" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='280' viewBox='0 0 200 280'%3E%3Crect fill='%23e0e0e0' width='200' height='280'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23999' font-size='14' font-family='Arial'%3E图书封面%3C/text%3E%3C/svg%3E" alt="封面预览">
                </div>
                
                <div class="status-bar">
                    <div>状态: <span id="statusText" class="save-indicator">就绪</span></div>
                    <div id="lastSaved">上次保存: 从未</div>
                </div>
            </section>
            
            <!-- 中间：章节管理 -->
            <section class="chapter-section">
                <h2 class="section-title"><i class="fas fa-list"></i> 章节管理</h2>
                
                <div class="controls">
                    <button class="btn" id="addChapterBtn">
                        <i class="fas fa-plus"></i> 添加章节
                    </button>
                    <button class="btn btn-danger" id="removeChapterBtn">
                        <i class="fas fa-trash"></i> 删除章节
                    </button>
                </div>
                
                <div class="chapters-container">
                    <ul class="chapter-list" id="chapterList">
                        <li class="empty-message" id="emptyChapterMessage">暂无章节，请添加新章节</li>
                    </ul>
                </div>
                
                <div class="form-group">
                    <label for="chapterTitle">章节标题</label>
                    <input type="text" id="chapterTitle" placeholder="请输入章节标题">
                </div>
                
                <div class="form-group">
                    <label for="chapterNumber">章节编号</label>
                    <input type="number" id="chapterNumber" placeholder="请输入章节编号" min="1">
                </div>
                
                <div class="controls">
                    <button class="btn btn-success" id="updateChapterBtn">
                        <i class="fas fa-sync"></i> 更新章节
                    </button>
                </div>
            </section>
            
            <!-- 右侧：内容编辑 -->
            <section class="content-section">
                <h2 class="section-title"><i class="fas fa-edit"></i> 内容编辑</h2>
                
                <div class="content-header">
                    <div class="content-title" id="currentChapterTitle">请选择章节</div>
                    <div class="content-subtitle" id="currentChapterSubtitle">点击左侧章节开始编辑内容</div>
                </div>
                
                <div class="content-container">
                    <textarea id="chapterContent" placeholder="在此输入章节内容..."></textarea>
                </div>
                
                <div class="controls" style="margin-top: 15px;">
                    <!-- 调整顺序：插入图片 → 保存内容 → 预览 -->
                    <button class="btn insert-image-btn" id="insertImageBtn">
                        <i class="fas fa-image"></i> 插入图片
                    </button>
                    <button class="btn btn-success" id="saveContentBtn">
                        <i class="fas fa-save"></i> 保存内容
                    </button>
                    <button class="btn" id="previewContentBtn">
                        <i class="fas fa-eye"></i> 预览内容
                    </button>
                </div>
                
                <div class="image-insert-form" id="imageInsertForm">
                    <div class="form-group">
                        <label for="imageUrl">图片链接</label>
                        <input type="text" id="imageUrl" placeholder="粘贴图片链接或上传图片">
                    </div>
                    
                    <div class="controls">
                        <div class="file-input-wrapper">
                            <div class="file-input-button">
                                <i class="fas fa-upload"></i> 上传图片
                            </div>
                            <input type="file" id="imageFileInput" accept="image/*">
                        </div>
                        <button class="btn btn-success" id="confirmInsertBtn">
                            <i class="fas fa-check"></i> 插入图片
                        </button>
                        <button class="btn btn-danger" id="cancelInsertBtn">
                            <i class="fas fa-times"></i> 取消
                        </button>
                    </div>
                    
                    <div id="imagePreviewContainer"></div>
                </div>
            </section>
        </div>
        
        <!-- 书库模态框 -->
        <div id="libraryModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2><i class="fas fa-bookmark"></i> 我的书库</h2>
                <div id="libraryBooks">
                    <div class="empty-message">您还没有创建任何图书</div>
                </div>
            </div>
        </div>
        
        <!-- 确认保存模态框 -->
        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <h3><i class="fas fa-exclamation-triangle"></i> 确认新建图书</h3>
                <p id="confirmMessage">当前图书有未保存的更改，确定要创建新图书吗？未保存的内容将会丢失。</p>
                <div class="controls" style="margin-top: 20px; justify-content: flex-end;">
                    <button class="btn btn-secondary" id="cancelNewBookBtn">取消</button>
                    <button class="btn btn-warning" id="saveAndNewBookBtn">保存并新建</button>
                    <button class="btn btn-danger" id="confirmNewBookBtn">不保存，直接新建</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentBook = {
            id: null,
            title: '',
            author: '',
            description: '',
            cover: '',
            chapters: [],
            lastModified: null
        };
        
        let currentChapterId = null;
        let hasUnsavedChanges = false;
        
        const bookTitleInput = document.getElementById('bookTitle');
        const bookAuthorInput = document.getElementById('bookAuthor');
        const bookDescriptionInput = document.getElementById('bookDescription');
        const bookCoverInput = document.getElementById('bookCover');
        const coverFileInput = document.getElementById('coverFileInput');
        const coverPreview = document.getElementById('coverPreview');
        const chapterList = document.getElementById('chapterList');
        const emptyChapterMessage = document.getElementById('emptyChapterMessage');
        const chapterTitleInput = document.getElementById('chapterTitle');
        const chapterNumberInput = document.getElementById('chapterNumber');
        const chapterContentTextarea = document.getElementById('chapterContent');
        const currentChapterTitle = document.getElementById('currentChapterTitle');
        const currentChapterSubtitle = document.getElementById('currentChapterSubtitle');
        const statusText = document.getElementById('statusText');
        const lastSaved = document.getElementById('lastSaved');
        const libraryModal = document.getElementById('libraryModal');
        const confirmModal = document.getElementById('confirmModal');
        const closeModal = document.querySelectorAll('.close')[0];
        const closeConfirmModal = document.querySelectorAll('.close')[1] || document.createElement('span');
        const insertImageBtn = document.getElementById('insertImageBtn');
        const imageInsertForm = document.getElementById('imageInsertForm');
        const imageUrlInput = document.getElementById('imageUrl');
        const imageFileInput = document.getElementById('imageFileInput');
        const confirmInsertBtn = document.getElementById('confirmInsertBtn');
        const cancelInsertBtn = document.getElementById('cancelInsertBtn');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const cancelNewBookBtn = document.getElementById('cancelNewBookBtn');
        const saveAndNewBookBtn = document.getElementById('saveAndNewBookBtn');
        const confirmNewBookBtn = document.getElementById('confirmNewBookBtn');
        const confirmMessage = document.getElementById('confirmMessage');
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('newBookBtn').addEventListener('click', checkUnsavedChanges);
            document.getElementById('saveBookBtn').addEventListener('click', saveBook);
            document.getElementById('loadBookBtn').addEventListener('click', showLibrary);
            document.getElementById('addChapterBtn').addEventListener('click', addChapter);
            document.getElementById('removeChapterBtn').addEventListener('click', removeChapter);
            document.getElementById('updateChapterBtn').addEventListener('click', updateChapter);
            document.getElementById('saveContentBtn').addEventListener('click', saveChapterContent);
            document.getElementById('previewContentBtn').addEventListener('click', previewContent);
            
            bookTitleInput.addEventListener('input', markUnsaved);
            bookAuthorInput.addEventListener('input', markUnsaved);
            bookDescriptionInput.addEventListener('input', markUnsaved);
            bookCoverInput.addEventListener('input', function() {
                markUnsaved();
                updateCoverPreview();
            });
            
            chapterTitleInput.addEventListener('input', markUnsaved);
            chapterNumberInput.addEventListener('input', markUnsaved);
            chapterContentTextarea.addEventListener('input', markUnsaved);
            
            coverFileInput.addEventListener('change', handleCoverUpload);
            
            insertImageBtn.addEventListener('click', toggleImageInsertForm);
            imageFileInput.addEventListener('change', handleImageUpload);
            confirmInsertBtn.addEventListener('click', insertImageToContent);
            cancelInsertBtn.addEventListener('click', closeImageInsertForm);
            
            cancelNewBookBtn.addEventListener('click', () => confirmModal.style.display = 'none');
            saveAndNewBookBtn.addEventListener('click', saveAndNewBook);
            confirmNewBookBtn.addEventListener('click', confirmNewBook);
            
            closeModal.addEventListener('click', () => libraryModal.style.display = 'none');
            window.addEventListener('click', (event) => {
                if (event.target === libraryModal) libraryModal.style.display = 'none';
                if (event.target === confirmModal) confirmModal.style.display = 'none';
            });
            
            loadBooksFromStorage();
        });
        
        function markUnsaved() {
            hasUnsavedChanges = true;
            if (!statusText.textContent.includes('未保存')) {
                statusText.textContent = '有未保存的更改';
                statusText.className = 'unsaved-warning';
            }
        }
        
        function loadBooksFromStorage() {
            const books = JSON.parse(localStorage.getItem('dream_books') || '[]');
            if (books.length > 0) {
                // 加载最新的图书作为示例
                currentBook = {...books[books.length - 1]};
                renderBookInfo();
                renderChapterList();
                updateStatusBar('数据已从本地加载', true);
                if (currentBook.lastModified) {
                    lastSaved.textContent = `上次保存: ${formatDate(currentBook.lastModified)}`;
                }
                hasUnsavedChanges = false;
            } else {
                initializeSampleData();
            }
        }
        
        function initializeSampleData() {
            currentBook = {
                id: 'sample_' + Date.now(),
                title: '梦幻之旅',
                author: '梦源作者',
                description: '这是一本关于梦想与探索的奇幻小说，讲述了主人公在神秘世界中的冒险故事。',
                cover: 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80',
                chapters: [
                    { id: 'ch-1', number: 1, title: '第一章 梦的开始', content: '很久很久以前，在一个遥远的地方...\n\n<div class="image-frame"><img src="https://images.unsplash.com/photo-1501854140801-50d01698950b?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80" alt="风景图"><button class="frame-controls" onclick="removeImageFrame(this)">×</button></div>\n\n主人公踏上了他的冒险之路。' },
                    { id: 'ch-2', number: 2, title: '第二章 神秘森林', content: '主人公踏入了传说中的神秘森林...' },
                    { id: 'ch-3', number: 3, title: '第三章 遇见精灵', content: '在森林深处，主人公遇见了一群友善的精灵...' }
                ],
                lastModified: new Date()
            };
            
            renderBookInfo();
            renderChapterList();
            updateStatusBar('就绪', true);
            lastSaved.textContent = `上次保存: ${formatDate(currentBook.lastModified)}`;
            hasUnsavedChanges = false;
        }
        
        function updateCoverPreview() {
            const url = bookCoverInput.value.trim();
            coverPreview.src = url || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'280\' viewBox=\'0 0 200 280\'%3E%3Crect fill=\'%23e0e0e0\' width=\'200\' height=\'280\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'%23999\' font-size=\'14\' font-family=\'Arial\'%3E图书封面%3C/text%3E%3C/svg%3E';
        }
        
        function handleCoverUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    bookCoverInput.value = e.target.result;
                    coverPreview.src = e.target.result;
                    markUnsaved();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function toggleImageInsertForm() {
            imageInsertForm.classList.toggle('active');
            if (imageInsertForm.classList.contains('active')) {
                imageUrlInput.focus();
            } else {
                closeImageInsertForm();
            }
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    imageUrlInput.value = e.target.result;
                    showImagePreview(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }
        
        function showImagePreview(url) {
            imagePreviewContainer.innerHTML = `<img src="${url}" class="image-preview" alt="预览图">`;
        }
        
        function closeImageInsertForm() {
            imageInsertForm.classList.remove('active');
            imageUrlInput.value = '';
            imagePreviewContainer.innerHTML = '';
        }
        
        function insertImageToContent() {
            const url = imageUrlInput.value.trim();
            if (!url) {
                alert('请输入图片链接或上传图片');
                return;
            }
            
            const imgHtml = `<div class="image-frame"><img src="${url}" alt="插入的图片"><button class="frame-controls" onclick="removeImageFrame(this)">×</button></div>`;
            
            const textarea = chapterContentTextarea;
            const startPos = textarea.selectionStart;
            const endPos = textarea.selectionEnd;
            const textBefore = textarea.value.substring(0, startPos);
            const textAfter = textarea.value.substring(endPos, textarea.value.length);
            
            textarea.value = textBefore + imgHtml + textAfter;
            textarea.selectionStart = textarea.selectionEnd = startPos + imgHtml.length;
            textarea.focus();
            markUnsaved();
            
            closeImageInsertForm();
        }
        
        window.removeImageFrame = function(button) {
            button.closest('.image-frame').remove();
        };
        
        function checkUnsavedChanges() {
            if (hasUnsavedChanges) {
                confirmMessage.textContent = '当前图书有未保存的更改，确定要创建新图书吗？未保存的内容将会丢失。';
                confirmModal.style.display = 'block';
            } else {
                createNewBook();
            }
        }
        
        function saveAndNewBook() {
            saveBook();
            setTimeout(() => {
                confirmModal.style.display = 'none';
                createNewBook();
            }, 100);
        }
        
        function confirmNewBook() {
            confirmModal.style.display = 'none';
            createNewBook();
        }
        
        function createNewBook() {
            currentBook = {
                id: 'book_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                title: '',
                author: '',
                description: '',
                cover: '',
                chapters: [],
                lastModified: new Date()
            };
            currentChapterId = null;
            hasUnsavedChanges = false;
            
            // 清空所有输入
            bookTitleInput.value = '';
            bookAuthorInput.value = '';
            bookDescriptionInput.value = '';
            bookCoverInput.value = '';
            coverPreview.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'280\' viewBox=\'0 0 200 280\'%3E%3Crect fill=\'%23e0e0e0\' width=\'200\' height=\'280\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'%23999\' font-size=\'14\' font-family=\'Arial\'%3E图书封面%3C/text%3E%3C/svg%3E';
            
            chapterTitleInput.value = '';
            chapterNumberInput.value = '';
            chapterContentTextarea.value = '';
            currentChapterTitle.textContent = '请选择章节';
            currentChapterSubtitle.textContent = '点击左侧章节开始编辑内容';
            
            renderChapterList();
            updateStatusBar('新建图书准备就绪', true);
            lastSaved.textContent = '上次保存: 从未';
        }
        
        function renderBookInfo() {
            bookTitleInput.value = currentBook.title || '';
            bookAuthorInput.value = currentBook.author || '';
            bookDescriptionInput.value = currentBook.description || '';
            bookCoverInput.value = currentBook.cover || '';
            updateCoverPreview();
        }
        
        function renderChapterList() {
            chapterList.innerHTML = '';
            
            if (currentBook.chapters.length === 0) {
                emptyChapterMessage.style.display = 'block';
                chapterList.appendChild(emptyChapterMessage);
                return;
            }
            
            emptyChapterMessage.style.display = 'none';
            const sortedChapters = [...currentBook.chapters].sort((a, b) => a.number - b.number);
            
            sortedChapters.forEach(chapter => {
                const li = document.createElement('li');
                li.className = 'chapter-item';
                li.dataset.id = chapter.id;
                if (currentChapterId === chapter.id) li.classList.add('active');
                
                li.innerHTML = `
                    <div class="item-content">
                        <span class="item-number">${chapter.number}</span>
                        <span class="item-title">${chapter.title}</span>
                    </div>
                    <div class="item-actions">
                        <button class="edit-btn" title="编辑"><i class="fas fa-edit"></i></button>
                    </div>
                `;
                
                li.addEventListener('click', () => selectChapter(chapter.id));
                li.querySelector('.edit-btn').addEventListener('click', e => {
                    e.stopPropagation();
                    editChapter(chapter.id);
                });
                
                chapterList.appendChild(li);
            });
        }
        
        function selectChapter(id) {
            currentChapterId = id;
            const chapter = currentBook.chapters.find(c => c.id === id);
            if (chapter) {
                chapterTitleInput.value = chapter.title || '';
                chapterNumberInput.value = chapter.number || '';
                chapterContentTextarea.value = chapter.content || '';
                currentChapterTitle.textContent = `第${chapter.number}章: ${chapter.title}`;
                currentChapterSubtitle.textContent = `字数: ${(chapter.content || '').length} 字`;
                renderChapterList();
            }
        }
        
        function editChapter(id) {
            const chapter = currentBook.chapters.find(c => c.id === id);
            if (chapter) {
                chapterTitleInput.value = chapter.title || '';
                chapterNumberInput.value = chapter.number || '';
                currentChapterId = id;
                renderChapterList();
            }
        }
        
        function addChapter() {
            const title = chapterTitleInput.value.trim();
            const number = parseInt(chapterNumberInput.value);
            
            if (!title) {
                alert('请输入章节标题');
                chapterTitleInput.focus();
                return;
            }
            
            if (!number || number <= 0) {
                alert('请输入有效的章节编号');
                chapterNumberInput.focus();
                return;
            }
            
            if (currentBook.chapters.some(c => c.number === number)) {
                alert(`章节编号 ${number} 已存在`);
                chapterNumberInput.focus();
                return;
            }
            
            currentBook.chapters.push({
                id: 'ch-' + Date.now(),
                number: number,
                title: title,
                content: ''
            });
            currentBook.lastModified = new Date();
            hasUnsavedChanges = true;
            renderChapterList();
            updateStatusBar('章节已添加', true);
        }
        
        function updateChapter() {
            if (!currentChapterId) {
                alert('请选择要更新的章节');
                return;
            }
            
            const title = chapterTitleInput.value.trim();
            const number = parseInt(chapterNumberInput.value);
            
            if (!title) {
                alert('请输入章节标题');
                chapterTitleInput.focus();
                return;
            }
            
            if (!number || number <= 0) {
                alert('请输入有效的章节编号');
                chapterNumberInput.focus();
                return;
            }
            
            const conflict = currentBook.chapters.find(c => c.id !== currentChapterId && c.number === number);
            if (conflict) {
                alert(`章节编号 ${number} 已存在`);
                chapterNumberInput.focus();
                return;
            }
            
            const idx = currentBook.chapters.findIndex(c => c.id === currentChapterId);
            if (idx !== -1) {
                currentBook.chapters[idx].title = title;
                currentBook.chapters[idx].number = number;
                currentBook.lastModified = new Date();
                hasUnsavedChanges = true;
                renderChapterList();
                selectChapter(currentChapterId);
                updateStatusBar('章节已更新', true);
            }
        }
        
        function removeChapter() {
            if (!currentChapterId) {
                alert('请选择要删除的章节');
                return;
            }
            
            const chapter = currentBook.chapters.find(c => c.id === currentChapterId);
            if (!chapter) return;
            
            if (confirm(`确定要删除章节 "${chapter.title}" 吗？`)) {
                currentBook.chapters = currentBook.chapters.filter(c => c.id !== currentChapterId);
                currentChapterId = null;
                currentBook.lastModified = new Date();
                hasUnsavedChanges = true;
                
                chapterTitleInput.value = '';
                chapterNumberInput.value = '';
                chapterContentTextarea.value = '';
                currentChapterTitle.textContent = '请选择章节';
                currentChapterSubtitle.textContent = '点击左侧章节开始编辑内容';
                
                renderChapterList();
                updateStatusBar('章节已删除', true);
            }
        }
        
        function saveChapterContent() {
            if (!currentChapterId) {
                alert('请选择要保存的章节');
                return;
            }
            
            const content = chapterContentTextarea.value;
            const chapterIndex = currentBook.chapters.findIndex(c => c.id === currentChapterId);
            
            if (chapterIndex !== -1) {
                currentBook.chapters[chapterIndex].content = content;
                currentBook.lastModified = new Date();
                hasUnsavedChanges = true;
                
                currentChapterSubtitle.textContent = `字数: ${content.length} 字`;
                
                updateStatusBar('内容已保存', true);
            }
        }
        
        function previewContent() {
            if (!currentChapterId) {
                alert('请选择要预览的章节');
                return;
            }
            
            const content = chapterContentTextarea.value;
            const chapter = currentBook.chapters.find(c => c.id === currentChapterId);
            
            if (!chapter) return;
            
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${chapter.title} - 预览</title>
                    <style>
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            max-width: 800px; 
                            margin: 0 auto; 
                            padding: 20px; 
                            line-height: 1.6;
                        }
                        h1 { color: #2c3e50; }
                        .chapter-meta { 
                            color: #7f8c8d; 
                            font-style: italic; 
                            margin-bottom: 20px; 
                            border-bottom: 1px solid #eee;
                            padding-bottom: 10px;
                        }
                        .image-frame {
                            display: inline-block;
                            position: relative;
                            margin: 10px;
                            border: 2px dashed #3498db;
                            border-radius: 5px;
                            padding: 5px;
                            background: #f8f9fa;
                        }
                        .image-frame img {
                            max-width: 100%;
                            height: auto;
                            display: block;
                        }
                    </style>
                </head>
                <body>
                    <h1>${chapter.title}</h1>
                    <div class="chapter-meta">第${chapter.number}章 | 字数: ${content.length}</div>
                    <div>${content.replace(/\n/g, '<br>')}</div>
                </body>
                </html>
            `);
        }
        
        function saveBook() {
            if (!bookTitleInput.value.trim()) {
                alert('请输入图书标题');
                bookTitleInput.focus();
                return;
            }
            
            if (!bookAuthorInput.value.trim()) {
                alert('请输入作者姓名');
                bookAuthorInput.focus();
                return;
            }
            
            updateStatusBar('保存中...', false);
            
            // 先保存当前正在编辑的章节内容（如果存在）
            if (currentChapterId) {
                const chapterIndex = currentBook.chapters.findIndex(c => c.id === currentChapterId);
                if (chapterIndex !== -1) {
                    currentBook.chapters[chapterIndex].content = chapterContentTextarea.value;
                }
            }
            
            // 更新当前图书的所有信息
            currentBook.title = bookTitleInput.value.trim();
            currentBook.author = bookAuthorInput.value.trim();
            currentBook.description = bookDescriptionInput.value.trim();
            currentBook.cover = bookCoverInput.value.trim();
            
            // 如果当前图书没有ID，创建一个唯一ID
            if (!currentBook.id) {
                currentBook.id = 'book_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            currentBook.lastModified = new Date();
            
            // 保存到本地存储
            let books = JSON.parse(localStorage.getItem('dream_books') || '[]');
            
            // 查找现有图书索引
            const existingIndex = books.findIndex(b => b.id === currentBook.id);
            
            if (existingIndex !== -1) {
                // 更新现有图书
                books[existingIndex] = { ...currentBook };
            } else {
                // 添加新图书
                books.push({ ...currentBook });
            }
            
            try {
                localStorage.setItem('dream_books', JSON.stringify(books));
                hasUnsavedChanges = false;
                updateStatusBar('图书已成功保存！', true);
                lastSaved.textContent = `上次保存: ${formatDate(currentBook.lastModified)}`;
                
                setTimeout(() => {
                    statusText.textContent = '就绪';
                    statusText.className = 'save-indicator';
                }, 3000);
            } catch (error) {
                updateStatusBar('保存失败：存储空间不足', false);
                statusText.classList.add('error');
                console.error('保存失败:', error);
            }
        }
        
        function showLibrary() {
            const books = JSON.parse(localStorage.getItem('dream_books') || '[]');
            const libraryBooks = document.getElementById('libraryBooks');
            
            if (books.length === 0) {
                libraryBooks.innerHTML = '<div class="empty-message">您还没有创建任何图书</div>';
            } else {
                libraryBooks.innerHTML = '';
                
                books.forEach(book => {
                    const bookCard = document.createElement('div');
                    bookCard.className = 'book-card';
                    bookCard.dataset.bookId = book.id;
                    
                    bookCard.innerHTML = `
                        <div class="book-card-header">
                            <img src="${book.cover || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'80\' viewBox=\'0 0 60 80\'%3E%3Crect fill=\'%23e0e0e0\' width=\'60\' height=\'80\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'%23999\' font-size=\'10\' font-family=\'Arial\'%3E封面%3C/text%3E%3C/svg%3E'}" 
                                 class="book-card-cover" 
                                 alt="${book.title}封面">
                            <div class="book-card-info">
                                <div class="book-card-title">${book.title || '未命名图书'}</div>
                                <div class="book-card-author">作者: ${book.author || '未知作者'}</div>
                            </div>
                        </div>
                        <div class="book-card-stats">
                            <span>章节: ${book.chapters?.length || 0}</span>
                            <span>更新: ${book.lastModified ? formatDate(book.lastModified) : '从未'}</span>
                        </div>
                        <div class="controls" style="margin-top: 10px;">
                            <button class="btn btn-danger delete-book-btn">删除</button>
                        </div>
                    `;
                    
                    bookCard.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-book-btn')) return;
                        
                        loadBookIntoEditor(book.id);
                    });
                    
                    const deleteBtn = bookCard.querySelector('.delete-book-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteBook(book.id, bookCard);
                    });
                    
                    libraryBooks.appendChild(bookCard);
                });
            }
            
            libraryModal.style.display = 'block';
        }
        
        function loadBookIntoEditor(bookId) {
            const books = JSON.parse(localStorage.getItem('dream_books') || '[]');
            const book = books.find(b => b.id === bookId);
            
            if (book) {
                currentBook = { ...book };
                currentChapterId = null;
                hasUnsavedChanges = false;
                renderBookInfo();
                renderChapterList();
                updateStatusBar('图书已加载', true);
                lastSaved.textContent = `上次保存: ${formatDate(currentBook.lastModified)}`;
                
                chapterTitleInput.value = '';
                chapterNumberInput.value = '';
                chapterContentTextarea.value = '';
                currentChapterTitle.textContent = '请选择章节';
                currentChapterSubtitle.textContent = '点击左侧章节开始编辑内容';
                
                libraryModal.style.display = 'none';
            }
        }
        
        function deleteBook(bookId, bookCardElement) {
            if (!confirm('确定要删除这本图书吗？此操作不可恢复。')) {
                return;
            }
            
            const books = JSON.parse(localStorage.getItem('dream_books') || '[]');
            const updatedBooks = books.filter(book => book.id !== bookId);
            
            try {
                localStorage.setItem('dream_books', JSON.stringify(updatedBooks));
                
                if (currentBook.id === bookId) {
                    createNewBook();
                }
                
                if (bookCardElement && bookCardElement.parentNode) {
                    bookCardElement.parentNode.removeChild(bookCardElement);
                }
                
                const libraryBooks = document.getElementById('libraryBooks');
                if (libraryBooks.children.length === 0) {
                    libraryBooks.innerHTML = '<div class="empty-message">您还没有创建任何图书</div>';
                }
                
                updateStatusBar('图书已删除', true);
            } catch (error) {
                updateStatusBar('删除失败', false);
                statusText.classList.add('error');
                console.error('删除失败:', error);
            }
        }
        
        function updateStatusBar(message, success = true) {
            statusText.textContent = message;
            statusText.className = 'save-indicator';
            
            if (!success) {
                statusText.classList.add('saving');
            } else if (message.includes('保存中')) {
                statusText.classList.add('saving');
            } else if (message.includes('未保存')) {
                statusText.className = 'unsaved-warning';
            }
        }
        
        function formatDate(date) {
            if (!date) return '从未';
            return new Date(date).toLocaleString('zh-CN');
        }
    </script>
</body>
</html>